"use strict";(self.webpackChunk_teamhanko_docs=self.webpackChunk_teamhanko_docs||[]).push([[559],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),p=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},c=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(n),m=a,h=c["".concat(l,".").concat(m)]||c[m]||u[m]||r;return n?o.createElement(h,i(i({ref:t},d),{},{components:n})):o.createElement(h,i({ref:t},d))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=c;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var p=2;p<r;p++)i[p]=n[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}c.displayName="MDXCreateElement"},5162:(e,t,n)=>{n.d(t,{Z:()=>i});var o=n(7294),a=n(6010);const r="tabItem_Ymn6";function i(e){let{children:t,hidden:n,className:i}=e;return o.createElement("div",{role:"tabpanel",className:(0,a.Z)(r,i),hidden:n},t)}},4866:(e,t,n)=>{n.d(t,{Z:()=>x});var o=n(7462),a=n(7294),r=n(6010),i=n(2466),s=n(6775),l=n(1980),p=n(7392),d=n(12);function u(e){return function(e){return a.Children.map(e,(e=>{if((0,a.isValidElement)(e)&&"value"in e.props)return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))}(e).map((e=>{let{props:{value:t,label:n,attributes:o,default:a}}=e;return{value:t,label:n,attributes:o,default:a}}))}function c(e){const{values:t,children:n}=e;return(0,a.useMemo)((()=>{const e=t??u(n);return function(e){const t=(0,p.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function m(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function h(e){let{queryString:t=!1,groupId:n}=e;const o=(0,s.k6)(),r=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l._X)(r),(0,a.useCallback)((e=>{if(!r)return;const t=new URLSearchParams(o.location.search);t.set(r,e),o.replace({...o.location,search:t.toString()})}),[r,o])]}function f(e){const{defaultValue:t,queryString:n=!1,groupId:o}=e,r=c(e),[i,s]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!m({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const o=n.find((e=>e.default))??n[0];if(!o)throw new Error("Unexpected error: 0 tabValues");return o.value}({defaultValue:t,tabValues:r}))),[l,p]=h({queryString:n,groupId:o}),[u,f]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[o,r]=(0,d.Nk)(n);return[o,(0,a.useCallback)((e=>{n&&r.set(e)}),[n,r])]}({groupId:o}),k=(()=>{const e=l??u;return m({value:e,tabValues:r})?e:null})();(0,a.useLayoutEffect)((()=>{k&&s(k)}),[k]);return{selectedValue:i,selectValue:(0,a.useCallback)((e=>{if(!m({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);s(e),p(e),f(e)}),[p,f,r]),tabValues:r}}var k=n(2389);const g="tabList__CuJ",w="tabItem_LNqP";function b(e){let{className:t,block:n,selectedValue:s,selectValue:l,tabValues:p}=e;const d=[],{blockElementScrollPositionUntilNextRender:u}=(0,i.o5)(),c=e=>{const t=e.currentTarget,n=d.indexOf(t),o=p[n].value;o!==s&&(u(t),l(o))},m=e=>{var t;let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const t=d.indexOf(e.currentTarget)+1;n=d[t]??d[0];break}case"ArrowLeft":{const t=d.indexOf(e.currentTarget)-1;n=d[t]??d[d.length-1];break}}null==(t=n)||t.focus()};return a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},t)},p.map((e=>{let{value:t,label:n,attributes:i}=e;return a.createElement("li",(0,o.Z)({role:"tab",tabIndex:s===t?0:-1,"aria-selected":s===t,key:t,ref:e=>d.push(e),onKeyDown:m,onClick:c},i,{className:(0,r.Z)("tabs__item",w,null==i?void 0:i.className,{"tabs__item--active":s===t})}),n??t)})))}function y(e){let{lazy:t,children:n,selectedValue:o}=e;if(n=Array.isArray(n)?n:[n],t){const e=n.find((e=>e.props.value===o));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return a.createElement("div",{className:"margin-top--md"},n.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==o}))))}function N(e){const t=f(e);return a.createElement("div",{className:(0,r.Z)("tabs-container",g)},a.createElement(b,(0,o.Z)({},e,t)),a.createElement(y,(0,o.Z)({},e,t)))}function x(e){const t=(0,k.Z)();return a.createElement(N,(0,o.Z)({key:String(t)},e))}},6239:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>m,frontMatter:()=>s,metadata:()=>p,toc:()=>u});var o=n(7462),a=(n(7294),n(3905)),r=n(4866),i=n(5162);const s={title:"Next.js and Hanko Tutorial",sidebar_label:"Next.js",keywords:["next","next.js"]},l="Using Hanko for a Todo app with Next.js 13 and Prisma",p={unversionedId:"guides/tutorials/nextjs",id:"guides/tutorials/nextjs",title:"Next.js and Hanko Tutorial",description:"In this tutorial, you\u2019ll learn how to build a Todo app with the Next.js 13 popular \u201cApp Router\u201d structure and understand some of the most important changes that come with it. We will build a fully functional todo app, handling the creation, updating when completed and the option to delete the todos.",source:"@site/docs/guides/tutorials/nextjs.mdx",sourceDirName:"guides/tutorials",slug:"/guides/tutorials/nextjs",permalink:"/guides/tutorials/nextjs",draft:!1,tags:[],version:"current",frontMatter:{title:"Next.js and Hanko Tutorial",sidebar_label:"Next.js",keywords:["next","next.js"]},sidebar:"docs",previous:{title:"Symfony",permalink:"/guides/tutorials/php"},next:{title:"User data",permalink:"/guides/tutorials/userData"}},d={},u=[{value:"Let\u2019s set it up",id:"lets-set-it-up",level:2},{value:"Initialize the Next.js app",id:"initialize-the-nextjs-app",level:3},{value:"Building the user interface",id:"building-the-user-interface",level:2},{value:"App structure",id:"app-structure",level:3},{value:"The Todo page",id:"the-todo-page",level:3},{value:"Todos in the making",id:"todos-in-the-making",level:2},{value:"API Routes in Next.js 13",id:"api-routes-in-nextjs-13",level:3},{value:"New Todo",id:"new-todo",level:3},{value:"Update and Delete todo by ID",id:"update-and-delete-todo-by-id",level:3},{value:"Authentication with Hanko",id:"authentication-with-hanko",level:2},{value:"Hanko Cloud setup",id:"hanko-cloud-setup",level:3},{value:"Adding Hanko to the Next.js app",id:"adding-hanko-to-the-nextjs-app",level:3},{value:"Verifying JWT with jose library",id:"verifying-jwt-with-jose-library",level:2},{value:"Securing the application and redirecting",id:"securing-the-application-and-redirecting",level:3},{value:"Time to display the right Todos",id:"time-to-display-the-right-todos",level:2}],c={toc:u};function m(e){let{components:t,...s}=e;return(0,a.kt)("wrapper",(0,o.Z)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"using-hanko-for-a-todo-app-with-nextjs-13-and-prisma"},"Using Hanko for a Todo app with Next.js 13 and Prisma"),(0,a.kt)("p",null,"In this tutorial, you\u2019ll learn how to build a Todo app with the Next.js 13 popular \u201cApp Router\u201d structure and understand some of the most important changes that come with it. We will build a fully functional todo app, handling the creation, updating when completed and the option to delete the todos."),(0,a.kt)("h2",{id:"lets-set-it-up"},"Let\u2019s set it up"),(0,a.kt)("p",null,"At Hanko, we understand that finding the right stack for the project is a big step. In this guide, we will bring Next.js as the main character of the project, we will test the Client vs Server Components. For the style, we will use Tailwind CSS. We will use Hanko for the login and registration, user management and logout. Prisma will handle the storage."),(0,a.kt)("h3",{id:"initialize-the-nextjs-app"},"Initialize the Next.js app"),(0,a.kt)("p",null,"To create a new Next.js app, we can use the ",(0,a.kt)("inlineCode",{parentName:"p"},"create-next-app")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"create-next-app@latest")," command-line tool followed by the name of your choice for the app. Open your terminal in Visual Studio Code and run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"npx create-next-app@latest todo-nextjs-hanko\n\nThen you\u2019ll be asked some prompts on what you will use for the app. The project configuration options should look something like this:\n\n![Pre-config Next.js prompts](/img/next-tutorial/next-config.png)\n\nThe above choices will create a new Next.js app with the chosen name, all the required dependencies for this project will also be installed.\n\n#### Understanding the project structure\n\nWhen using the version 13 of Next.js, we have the option to work with the App Router directory instead of the Pages Router, for a quick summary we could say that:\n\n- The new directory named \u201capp\u201d is replacing \u201cpages\u201d\n- \u201cpage.tsx|page.jsx\u201d is the new \u201cindex.tsx|index.jsx\u201d\n- \u201clayout.tsx\u201d is the new \u201c\\_app.tsx\u201d\n- Everything is a Server Component unless you make it a Client Component using the \u201cuse client\u201d directive at the top of the file.\n- API Routes are now Server Components or Route Handlers (... More info on how this is very important)\n\nRemove unnecessary files, such as logos, icons, etc. If you are going to use Tailwind CSS make sure to bring your desired configuration to the `tailwind.config.ts` file, defining your color palette, fonts, breakpoints, ect.\n\n\u2139\ufe0f For more information about the App Router of Next.js click [here](https://nextjs.org/docs).\n\n### Setting up Prisma\n\nInstall the Prisma CLI as a development dependency in the project:\n\n```shell npm2yarn\n$ npm install prisma --save-dev\n")),(0,a.kt)("p",null,"Set up Prisma with the init command of the Prisma CLI:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'npx prisma init --datasource-provider sqlite\n\nThis creates a new `prisma` directory with your Prisma schema file and configures SQLite as your database. Once we also create the "Todo" model, the Prisma schema file should look like this:\n\n')),(0,a.kt)("p",null,"// This is your Prisma schema file,\n// learn more about it in the docs: ",(0,a.kt)("a",{parentName:"p",href:"https://pris.ly/d/prisma-schema"},"https://pris.ly/d/prisma-schema")),(0,a.kt)("p",null,'generator client {\nprovider = "prisma-client-js"\n}'),(0,a.kt)("p",null,'datasource db {\nprovider = "sqlite"\nurl      = env("DATABASE_URL")\n}'),(0,a.kt)("p",null,"model Todo {"),(0,a.kt)("p",null," id String @id @default(uuid())\ntitle String\ncomplete Boolean\ncreatedAt DateTime @default(now())\nupdatedAt DateTime @updatedAt\n}"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"\nAt this point, you have a Prisma schema but no database yet. Run the following command in your terminal to create the SQLite database and the Todo table:\n\n")),(0,a.kt)("p",null,"npx prisma migrate dev --name init"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'\nThis command did two things:\n\n1. It creates a new SQL migration file for this migration in the `prisma/migrations` directory.\n2. It runs the SQL migration file against the database.\n\nBecause the SQLite database file didn\'t exist before, the command also created it inside the `prisma` directory with the name `dev.db` as defined via the environment variable in the `.env` file.\n\nTo prevent problems when instantiating PrismaClient, on the Prisma Docs there\u2019s a [section](https://www.prisma.io/docs/guides/other/troubleshooting-orm/help-articles/nextjs-prisma-client-dev-practices) dedicated to the best practice to do it. Let\u2019s try it by creating a `db.ts` file in the root of the app and add the following code inside:\n\n```js\nimport { PrismaClient } from "@prisma/client";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== "production") globalForPrisma.prisma = prisma;\n')),(0,a.kt)("p",null,"\u2139\ufe0f For more information about Prisma integration click ",(0,a.kt)("a",{parentName:"p",href:"https://www.prisma.io/docs/getting-started"},"here"),"."),(0,a.kt)("h2",{id:"building-the-user-interface"},"Building the user interface"),(0,a.kt)("p",null,'The goal is to build a simple "todo app" with a nice login to protect the todos, for this we will only need two pages:'),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The login page where the Hanko-auth component will play its part in handling authentication."),(0,a.kt)("li",{parentName:"ul"},"The todo page where all the todos will be displayed.")),(0,a.kt)("h3",{id:"app-structure"},"App structure"),(0,a.kt)("p",null,"In the App Router directory, the ",(0,a.kt)("inlineCode",{parentName:"p"},"page.tsx")," is like the new ",(0,a.kt)("inlineCode",{parentName:"p"},"index.tsx"),", which means that this name will play an important role when creating a new route. You can define a page by exporting a component from a ",(0,a.kt)("inlineCode",{parentName:"p"},"page.tsx")," file."),(0,a.kt)("p",null,"Now you can update the ",(0,a.kt)("inlineCode",{parentName:"p"},"page.tsx"),' file to display "Hello World" as done below.'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"export default function Home() {\n  return (\n    <div>\n      <p>Hello World</p>\n    </div>\n  );\n}\n")),(0,a.kt)("p",null,"We will get back to it later to add a nice login with Hanko."),(0,a.kt)("h3",{id:"the-todo-page"},"The Todo page"),(0,a.kt)("p",null,"We will style this page using Tailwind CSS classes to create a centered container to display the todos. We need a form with an input to create the new todos, and every todo element will have a checkbox and a delete button. Inside the ",(0,a.kt)("inlineCode",{parentName:"p"},"app")," directory, create a new ",(0,a.kt)("inlineCode",{parentName:"p"},"todo")," folder with a ",(0,a.kt)("inlineCode",{parentName:"p"},"page.tsx")," file inside of it. Use the code below as the ",(0,a.kt)("inlineCode",{parentName:"p"},"todo/page.tsx")," contents:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'export default function Todo() {\n  return (\n    <main className=" flex min-h-screen justify-center items-center bg-slate-50 ">\n      <div className="bg-slate-300 rounded-3xl py-6  h-[400px] w-[450px] flex flex-col text-slate-800">\n        <h1 className="text-3xl text-center">My to dos</h1>\n        <div className="mx-8 mt-4 mb-6">\n          <form className="flex gap-3 items-center">\n            <input\n              type="text"\n              name="title"\n              placeholder="New todo"\n              className=" border border-slate-400 rounded-full flex-1  py-1 px-2 outline-none focus-within:border-slate-100 bg-slate-50 focus-within:bg-slate-100 placeholder:text-slate-300"\n              required\n            />\n            <button className="  bg-slate-50 rounded-full p-1 border border-slate-400 text-slate-400 hover:text-slate-500 text-base hover:ring-0 hover:ring-slate-100 hover:border-slate-500">\n              <p className=" text-center">+</p>\n            </button>\n          </form>\n        </div>\n        <ul className="px-6">\n          <li className="flex px-4">\n            <span className="flex gap-2 flex-1">\n              <input\n                type="checkbox"\n                name="check"\n                className="peer cursor-pointer accent-slate-300 "\n              />\n              <label\n                htmlFor=""\n                className="peer-checked:line-through peer-checked:text-slate-500 cursor-pointer"\n              >\n                Todo 1\n              </label>\n            </span>\n            <button className="text-slate-500  hover:text-slate-800 mr-3">\n              X\n            </button>\n          </li>\n        </ul>\n      </div>\n    </main>\n  );\n}\n')),(0,a.kt)("p",null,"\u2139\ufe0f For a better understanding of the Tailwind CSS classes click ",(0,a.kt)("a",{parentName:"p",href:"https://tailwindcomponents.com/cheatsheet/"},"here"),"."),(0,a.kt)("h2",{id:"todos-in-the-making"},"Todos in the making"),(0,a.kt)("p",null,"To make our app functional, we need to be able to create a new todo, then check the todo once it\u2019s completed and finally be able to remove a single todo from the list."),(0,a.kt)("h3",{id:"api-routes-in-nextjs-13"},"API Routes in Next.js 13"),(0,a.kt)("p",null,"What we know as API Routes are replaced by Route Handlers and they are defined in a ",(0,a.kt)("inlineCode",{parentName:"p"},"route.ts|js")," file inside the ",(0,a.kt)("inlineCode",{parentName:"p"},"app")," directory. Read more about the Route Handlers in the ",(0,a.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/app/building-your-application/routing/route-handlers"},"Next.js Docs"),"."),(0,a.kt)("p",null,"Inside the ",(0,a.kt)("inlineCode",{parentName:"p"},"app")," directory create an ",(0,a.kt)("inlineCode",{parentName:"p"},"api")," folder. We will group our Route Handlers as follows: one directory ",(0,a.kt)("inlineCode",{parentName:"p"},"todo")," with a ",(0,a.kt)("inlineCode",{parentName:"p"},"route.tsx")," which will contain the ",(0,a.kt)("inlineCode",{parentName:"p"},"POST")," HTTP method handler for creating a new todo, and in that same directory we will use a dynamic route to ",(0,a.kt)("inlineCode",{parentName:"p"},"GET")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"DELETE")," todos. Should look like the following example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"api\n\u2514\u2500\u2500 todo\n    \u251c\u2500\u2500 [id]\n    \u2502   \u2514\u2500\u2500 route.ts\n    \u2514\u2500\u2500 route.ts\n")),(0,a.kt)("h3",{id:"new-todo"},"New Todo"),(0,a.kt)("p",null,"This is a good moment to start breaking it down into components, let\u2019s first create a ",(0,a.kt)("inlineCode",{parentName:"p"},"components")," folder at the root directory, then create a ",(0,a.kt)("inlineCode",{parentName:"p"},"components/todos/NewTodo.tsx")," file and use the following as its contents:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'"use client";\nimport { useState } from "react";\nimport { useRouter } from "next/navigation";\n\nexport const NewTodo = () => {\n  const [newItem, setNewItem] = useState("");\n\n  const router = useRouter();\n  const create = async (e: React.SyntheticEvent) => {\n    e.preventDefault();\n    await fetch(`/api/todo`, {\n      method: "POST",\n      credentials: "include",\n      headers: {\n        "Content-Type": "application/json",\n      },\n      body: JSON.stringify({\n        title: newItem,\n      }),\n    });\n\n    router.refresh();\n    setNewItem("");\n  };\n  return (\n    <div className="mx-8 mt-4 mb-6">\n      <form onSubmit={create} className="flex gap-3 items-center">\n        <input\n          type="text"\n          name="title"\n          value={newItem}\n          onChange={(e) => setNewItem(e.target.value)}\n          placeholder="New todo"\n          className=" border border-slate-400 rounded-full flex-1  py-1 px-2 outline-none focus-within:border-slate-100 bg-slate-50 focus-within:bg-slate-100 placeholder:text-slate-300"\n          required\n        />\n        <button\n          type="submit"\n          className="  bg-slate-50 rounded-full p-1 border border-slate-400 text-slate-400 hover:text-slate-500 text-base hover:ring-0 hover:ring-slate-100 hover:border-slate-500"\n        >\n          <p className=" text-center">+</p>\n        </button>\n      </form>\n    </div>\n  );\n};\n')),(0,a.kt)("p",null,'This is a good example of where to use the "use client" directive since we are using ',(0,a.kt)("inlineCode",{parentName:"p"},"useState()")," and subscribing to interactive events."),(0,a.kt)("p",null,"This is how we call Prisma to create the todo inside the ",(0,a.kt)("inlineCode",{parentName:"p"},"api/todo/route.ts")," Route Handler:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'import { NextResponse } from "next/server";\nimport { prisma } from "@/db";\n\nexport async function POST(req: Request) {\n  const { title } = await req.json();\n\n  await prisma.todo.create({\n    data: { title, complete: false },\n  });\n\n  return NextResponse.json({ message: "Created Todo" }, { status: 200 });\n}\n')),(0,a.kt)("p",null,"By default, Next.js uses Server Components, thanks to that we can now call Prisma from the ",(0,a.kt)("inlineCode",{parentName:"p"},"todo/page.tsx")," file to get all our todos, then we pass them to our ",(0,a.kt)("inlineCode",{parentName:"p"},"components/todos/TodoItem.tsx")," file to be displayed. This is how the ",(0,a.kt)("inlineCode",{parentName:"p"},"todo/page.tsx")," should look after our changes:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'import { NewTodo } from "@/components/todos/NewTodo";\nimport { TodoItem } from "@/components/todos/TodoItem";\nimport { prisma } from "@/db";\n\nexport default async function Todo() {\n  const todos = await prisma.todo.findMany();\n\n  return (\n    <main className=" flex min-h-screen justify-center items-center bg-slate-50 ">\n      <div className="bg-slate-300 rounded-3xl py-6  h-[400px] w-[450px] flex flex-col text-slate-800">\n        <h1 className="text-3xl text-center">My to dos</h1>\n        <NewTodo />\n        <ul className="px-6">\n          <TodoItem todos={todos} />\n        </ul>\n      </div>\n    </main>\n  );\n}\n')),(0,a.kt)("p",null,"\ud83d\udea8 Client Components themselves cannot be async functions (",(0,a.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/messages/no-async-client-component"},"official FAQ"),"). Prisma will break the app if you try to call it inside a Client Component."),(0,a.kt)("h3",{id:"update-and-delete-todo-by-id"},"Update and Delete todo by ID"),(0,a.kt)("p",null,"In the next step, we need a way to handle marking a todo as completed and to handle the deletion of a todo. Accordingly, we create ",(0,a.kt)("inlineCode",{parentName:"p"},"update")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"delete")," functions that fetch our dynamic route. This would be the ",(0,a.kt)("inlineCode",{parentName:"p"},"components/todos/TodoItem.tsx")," file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'"use client";\nimport { useRouter } from "next/navigation";\nimport { Todo } from "@prisma/client";\n\nexport const TodoItem = ({ todos }: { todos: Todo[] }) => {\n  const router = useRouter();\n  const update = async (todo: Todo) => {\n    await fetch(`/api/todo/${todo.id}`, {\n      method: "PATCH",\n      headers: {\n        "Content-Type": "application/json",\n      },\n      body: JSON.stringify({\n        completed: !todo.complete,\n      }),\n    });\n    router.refresh();\n  };\n\n  const deleteTodo = async (todo: Todo) => {\n    await fetch(`/api/todo/${todo.id}`, {\n      method: "DELETE",\n      headers: {\n        "Content-Type": "application/json",\n      },\n      body: JSON.stringify({\n        id: todo.id,\n      }),\n    });\n\n    router.refresh();\n  };\n  return (\n    <>\n      {todos.map((todo) => {\n        return (\n          <li key={todo.id} className="flex px-4">\n            <span className="flex gap-2 flex-1">\n              <input\n                type="checkbox"\n                name="check"\n                checked={todo.complete}\n                onChange={() => update(todo)}\n                className="peer cursor-pointer accent-slate-300 "\n              />\n              <label\n                htmlFor={todo.id}\n                className="peer-checked:line-through peer-checked:text-slate-500 cursor-pointer"\n              >\n                {todo.title}\n              </label>\n            </span>\n            <button\n              onClick={() => deleteTodo(todo)}\n              className="text-slate-500  hover:text-slate-800 mr-3"\n            >\n              X\n            </button>\n          </li>\n        );\n      })}\n    </>\n  );\n};\n')),(0,a.kt)("p",null,"Add the following code inside the ",(0,a.kt)("inlineCode",{parentName:"p"},"api/todo/[id]/route.tsx")," Route Handler:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'import { NextResponse } from "next/server";\nimport { prisma } from "@/db";\n\nexport async function PATCH(\n  req: Request,\n  { params: { id } }: { params: { id: string } }\n) {\n  const { completed } = await req.json();\n\n  await prisma.todo.update({\n    where: {\n      id: id,\n    },\n    data: {\n      complete: completed,\n    },\n  });\n  return NextResponse.json({ message: "Updated" }, { status: 200 });\n}\n\nexport async function DELETE(req: Request) {\n  const { id } = await req.json();\n\n  await prisma.todo.delete({\n    where: {\n      id: id,\n    },\n  });\n  return NextResponse.json({ message: "Deleted Item" }, { status: 200 });\n}\n')),(0,a.kt)("p",null,"\u2139\ufe0f For more information on the Prisma Client Api click ",(0,a.kt)("a",{parentName:"p",href:"https://www.prisma.io/docs/reference/api-reference/prisma-client-reference"},"here"),"."),(0,a.kt)("h2",{id:"authentication-with-hanko"},"Authentication with Hanko"),(0,a.kt)("p",null,"Now is time to start working on the security."),(0,a.kt)("h3",{id:"hanko-cloud-setup"},"Hanko Cloud setup"),(0,a.kt)("p",null,"Visit ",(0,a.kt)("a",{parentName:"p",href:"https://cloud.hanko.io/login"},"Hanko Cloud")," and create an account. Then create an organization to manage your Hanko project."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Hanko Cloud Organization",src:n(5438).Z,width:"1016",height:"624"})),(0,a.kt)("p",null,"Then create a new project and set the App URL to your development URL (example: http://localhost:3000):"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Hanko Cloud Project",src:n(6438).Z,width:"802",height:"715"})),(0,a.kt)("p",null,'And that\u2019s all! Now you can always return to your Hanko Cloud dashboard to see your API URL and other insights about your project, you can also change the app URL in the settings, so that once you want to move from "development" to "production", you can change it to a proper domain/URL. Take the time to discover all the features.'),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Hanko Cloud dashboard",src:n(113).Z,width:"1270",height:"714"})),(0,a.kt)("h3",{id:"adding-hanko-to-the-nextjs-app"},"Adding Hanko to the Next.js app"),(0,a.kt)("p",null,"Let\u2019s bring Hanko to the game by installing the ",(0,a.kt)("inlineCode",{parentName:"p"},"@teamhanko/hanko-elements")," package running the code below:"),(0,a.kt)(r.Z,{mdxType:"Tabs"},(0,a.kt)(i.Z,{value:"npm",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"npm install @teamhanko/hanko-elements\n"))),(0,a.kt)(i.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},"yarn add @teamhanko/hanko-elements\n")))),(0,a.kt)("p",null,'First, let\u2019s update our "Home" page and rename the function to "Login". Import the register function from ',(0,a.kt)("inlineCode",{parentName:"p"},"@teamhanko/hanko-elements"),", and call the function with the Hanko API URL as an argument to register the ",(0,a.kt)("inlineCode",{parentName:"p"},"<hanko-auth>"),". Now include it in your JSX:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'"use client";\nimport { useEffect } from "react";\nimport { register } from "@teamhanko/hanko-elements";\n\nconst hankoApi = "YOUR_HANKO_API_URL";\nexport default function Login() {\n  useEffect(() => {\n    //\n    register(hankoApi ?? "").catch((error) => {\n      console.log(error);\n    });\n  }, []);\n\n  return (\n    <div className="flex min-h-screen justify-center items-center ">\n      <hanko-auth />\n    </div>\n  );\n}\n')),(0,a.kt)("p",null,"The code snippet above should display the Hanko authentication component:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Hanko Authentication component",src:n(9879).Z,width:"468",height:"269"})),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"<hanko-profile>")," component offers a page for managing email addresses and passkeys. Let's create a profile button component by creating a file ",(0,a.kt)("inlineCode",{parentName:"p"},"components/Profile.tsx")," and use the following code as its content:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'"use client";\nimport { useEffect, useState } from "react";\nimport { register } from "@teamhanko/hanko-elements";\n\nconst hankoApi = "YOUR_HANKO_API_URL";\n\nexport const Profile = () => {\n  const [openState, setOpenState] = useState(false);\n\n  useEffect(() => {\n    register(hankoApi ?? "").catch((error) => {\n      console.log(error);\n    });\n  }, []);\n\n  const openProfile = () => {\n    setOpenState(!openState);\n  };\n\n  return (\n    <>\n      <button type="button" onClick={openProfile}>\n        Profile\n      </button>\n      {openState && (\n        <div className=" absolute top-14 ">\n          <section className=" w-[450px] h-auto rounded-2xl bg-white p-5">\n            <hanko-profile />\n          </section>\n        </div>\n      )}\n    </>\n  );\n};\n')),(0,a.kt)("p",null,"It should look like this:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Hanko Profile Component",src:n(636).Z,width:"546",height:"348"})),(0,a.kt)("p",null,"Now let\u2019s use ",(0,a.kt)("inlineCode",{parentName:"p"},"@teamhanko/hanko-elements")," to manage user logouts by creating a logout button component. Create a file ",(0,a.kt)("inlineCode",{parentName:"p"},"components/Logout.tsx")," and use the following as its content:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'"use client";\nimport { useState, useEffect, useCallback } from "react";\nimport { useRouter } from "next/navigation";\nimport { Hanko } from "@teamhanko/hanko-elements";\n\nconst hankoApi = "YOUR_HANKO_API_URL";\n\nexport const Logout = () => {\n  const router = useRouter();\n  const [hanko, setHanko] = useState<Hanko>();\n\n  useEffect(() => {\n    import("@teamhanko/hanko-elements").then(({ Hanko }) =>\n      setHanko(new Hanko(hankoApi ?? ""))\n    );\n  }, []);\n\n  const logout = () => {\n    hanko?.user\n      .logout()\n      .then(() => {\n        router.push("/");\n        router.refresh();\n        return;\n      })\n      .catch((error) => {\n        console.log(error);\n      });\n  };\n  return (\n    <>\n      <button type="button" onClick={logout}>Logout</button>\n    </>\n  );\n};\n')),(0,a.kt)("p",null,"When a user logs out, a specific event is triggered that you can subscribe to, like redirecting to a specific page after logout:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'const renewSession = useCallback(() => {\n  router.replace("/");\n}, [router]);\n\nuseEffect(\n  () =>\n    hanko?.onSessionExpired(() => {\n      renewSession();\n    }),\n\n  [hanko, renewSession]\n);\n')),(0,a.kt)("p",null,'\u2139\ufe0f For more information about all the events that you can "listen" from the Hanko client click ',(0,a.kt)("a",{parentName:"p",href:"https://github.com/teamhanko/hanko/blob/main/frontend/elements/README.md#events"},"here"),"."),(0,a.kt)("p",null,"\u2139\ufe0f You can also find information on how to customize Hanko Components by clicking ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/teamhanko/hanko/blob/main/frontend/elements/README.md#ui-customization"},"here"),"."),(0,a.kt)("h2",{id:"verifying-jwt-with-jose-library"},"Verifying JWT with jose library"),(0,a.kt)("p",null,"Hanko issues a cookie after a successful login. The value of this cookie is a JWT and to secure our app we still need to verify the JWT."),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("strong",{parentName:"p"},"What are JWTs?")," > ",(0,a.kt)("em",{parentName:"p"},"A JSON Web Token (JWT) is a compact and self-contained way for transmitting information between parties as a JSON object in a secure way. The purpose of a JWT is to ensure the authenticity of the data."))),(0,a.kt)("p",null,"Hanko handles the authentication and signing of the JWT. On successful authentication with Hanko a cookie, which contains said JWT as its value, is set. We don\u2019t really need to know a lot about JWTs, but it\u2019s worth getting familiar with the parts of a JWT (header, payload and signature), and  with what a ",(0,a.kt)("a",{parentName:"p",href:"https://auth0.com/docs/secure/tokens/json-web-tokens/json-web-key-sets"},"JWKS")," is. For more information you can visit ",(0,a.kt)("a",{parentName:"p",href:"https://jwt.io/"},"JWT.io"),"."),(0,a.kt)("p",null,"To verify the JWT we need to install the ",(0,a.kt)("inlineCode",{parentName:"p"},"jose")," package:"),(0,a.kt)(r.Z,{mdxType:"Tabs"},(0,a.kt)(i.Z,{value:"npm",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'npm install jose\n\n`jose` is a JavaScript module that supports JWT and provides functionality for signing and verifying tokens.\n\n\u2139\ufe0f For more information about `jose` click [here](https://www.npmjs.com/package/jose).\n\n### Middleware\n\nCreate a new file `middleware.tsx` in the root of your project and use the following code:\n\n```js\nimport * as jose from "jose";\nimport { NextRequest } from "next/server";\n\nconst hankoApi = "YOUR_HANKO_API_URL";\n\nexport default async function middleware(req: NextRequest) {\n  const token = req.cookies.get("hanko")?.value;\n\n  const JWKS = jose.createRemoteJWKSet(\n    new URL(`${hankoApi}/.well-known/jwks.json`)\n  );\n\n  try {\n    const verifiedJWT = await jose.jwtVerify(token, JWKS);\n    console.log(verifiedJWT);\n  } catch {\n    return NextResponse.redirect(new URL("/", req.url));\n  }\n}\n'))),(0,a.kt)(i.Z,{value:"yarn",label:"Yarn",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-shell"},'yarn add jose\n\n`jose` is a JavaScript module that supports JWT and provides functionality for signing and verifying tokens.\n\n\u2139\ufe0f For more information about `jose` click [here](https://www.yarn \n# couldn\'t auto-convert commandjs.com/package/jose).\n\n### Middleware\n\nCreate a new file `middleware.tsx` in the root of your project and use the following code:\n\n```js\nimport * as jose from "jose";\nimport { NextRequest } from "next/server";\n\nconst hankoApi = "YOUR_HANKO_API_URL";\n\nexport default async function middleware(req: NextRequest) {\n  const token = req.cookies.get("hanko")?.value;\n\n  const JWKS = jose.createRemoteJWKSet(\n    new URL(`${hankoApi}/.well-known/jwks.json`)\n  );\n\n  try {\n    const verifiedJWT = await jose.jwtVerify(token, JWKS);\n    console.log(verifiedJWT);\n  } catch {\n    return NextResponse.redirect(new URL("/", req.url));\n  }\n}\n')))),(0,a.kt)("p",null,'To verify the JWT we need the token and the JWKS. We get the token from the "hanko" cookie, and then we obtain the JSON Web Key Set (JWKS) calling the ',(0,a.kt)("inlineCode",{parentName:"p"},"createRemoteJWKSet")," function from jose. Then we call ",(0,a.kt)("inlineCode",{parentName:"p"},"await jose.jwtVerify(token, JWKS)"),". If the token can be verified, then the promise returned from the function resolves to a decoded token. If it cannot be verified, then the promise rejects and we can catch the error and handle it appropriately, e.g. by redirecting the user to the login/home page. If you console.log the const ",(0,a.kt)("inlineCode",{parentName:"p"},"verifiedJWT"),' you should see the decoded token showing the payload, the protectedHeader and the key. Inside the key, you should be able to see a "true" if it\u2019s verified.'),(0,a.kt)("p",null,"\u2139\ufe0f For more information about Next.js Middleware click ",(0,a.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/app/building-your-application/routing/middleware#conditional-statements"},"here"),"."),(0,a.kt)("h3",{id:"securing-the-application-and-redirecting"},"Securing the application and redirecting"),(0,a.kt)("p",null,"To prevent unauthorized users from getting access to private user data, we can add the paths to be protected in the Middleware configuration. Following the example on the Next.js Docs about the ",(0,a.kt)("a",{parentName:"p",href:"https://nextjs.org/docs/app/building-your-application/routing/middleware#example"},"middleware"),",  copy the following code to the bottom of your ",(0,a.kt)("inlineCode",{parentName:"p"},"middleware.tsx")," file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'export const config = {\n  matcher: ["/todo"],\n};\n')),(0,a.kt)("p",null,"Update the ",(0,a.kt)("inlineCode",{parentName:"p"},"Login")," page to subscribe to the events of the Hanko client and redirect to the ",(0,a.kt)("inlineCode",{parentName:"p"},"Todo")," page after a successful login:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'"use client";\nimport { useEffect, useState, useCallback } from "react";\nimport { useRouter } from "next/navigation";\nimport { register } from "@teamhanko/hanko-elements";\n\nconst hankoApi = "YOUR_HANKO_API_URL";\nexport default function Login() {\n  const router = useRouter();\n  const [hanko, setHanko] = useState<Hanko>();\n\n  useEffect(() => {\n    import("@teamhanko/hanko-elements").then(({ Hanko }) =>\n      setHanko(new Hanko(hankoApi ?? ""))\n    );\n  }, []);\n\n  const redirectAfterLogin = useCallback(() => {\n    router.replace("/todo");\n  }, [router]);\n\n  useEffect(\n    () =>\n      hanko?.onAuthFlowCompleted(() => {\n        redirectAfterLogin();\n      }),\n    [hanko, redirectAfterLogin]\n  );\n\n  useEffect(() => {\n    //\n    register(hankoApi ?? "").catch((error) => {\n      console.log(error);\n    });\n  }, []);\n\n  return (\n    <div className="flex min-h-screen justify-center items-center bg-slate-50">\n      <div className="bg-white p-5 rounded-2xl shadow-md">\n        <hanko-auth />\n      </div>\n    </div>\n  );\n}\n\n')),(0,a.kt)("h2",{id:"time-to-display-the-right-todos"},"Time to display the right Todos"),(0,a.kt)("p",null,'Lastly, we should only display the todos for the user that is logged in. To do so, we need to link the todos to the correct "user ID". The first step is to update the Todo model in the ',(0,a.kt)("inlineCode",{parentName:"p"},"prisma schema"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"model Todo {\n  userId String\n  id String @id @default(uuid())\n  title String\n  complete Boolean\n  createdAt DateTime @default(now())\n  updatedAt DateTime @updatedAt\n}\n")),(0,a.kt)("p",null,"Then run the following command to create a migration:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"npx prisma migrate\n")),(0,a.kt)("p",null,"Or the following to push the schema changes directly to the database:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"npx prisma db push\n")),(0,a.kt)("p",null,"The next step is to update the ",(0,a.kt)("inlineCode",{parentName:"p"},"api/todo/route.tsx")," file to get the user ID from the token, then create a new todo if there is a user ID:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'import { NextResponse } from "next/server";\nimport { cookies } from "next/headers";\nimport * as jose from "jose";\nimport { prisma } from "@/db";\n\nexport async function userId() {\n  const token = cookies().get("hanko")?.value;\n  const payload = jose.decodeJwt(token ?? "");\n\n  return payload.sub;\n}\n\nexport async function POST(req: Request) {\n  const userID = await userId();\n  const { title } = await req.json();\n\n  if (userID) {\n    if (typeof title !== "string" || title.length === 0) {\n      throw new Error("That can\'t be a title");\n    }\n    await prisma.todo.create({\n      data: { title, complete: false, userId: userID ?? "" },\n    });\n\n    return NextResponse.json({ message: "Created Todo" }, { status: 200 });\n  } else {\n    return NextResponse.json({ error: "Not Found" }, { status: 404 });\n  }\n}\n')),(0,a.kt)("p",null,"The final step is to update the Prisma call to fetch all the todos from the ",(0,a.kt)("inlineCode",{parentName:"p"},"todo/page.tsx"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},'import { Logout } from "@/components/Logout";\nimport { Profile } from "@/components/Profile";\nimport { NewTodo } from "@/components/todos/NewTodo";\nimport { TodoItem } from "@/components/todos/TodoItem";\nimport { prisma } from "@/db";\nimport { userId } from "../api/todo/route";\n\nexport default async function Todo() {\n  const userID = await userId();\n\n  const todos = await prisma.todo.findMany({\n    where: {\n      userId: { equals: userID },\n    },\n  });\n\n  return (\n    <main className=" flex flex-col min-h-screen justify-center items-center bg-slate-50 relative ">\n      <div className="absolute top-4 left-16">\n        <div className=" relative py-4 space-x-6">\n          <Profile />\n          <Logout />\n        </div>\n      </div>\n      <div className="bg-slate-300 rounded-3xl py-6  h-[400px] w-[450px] flex flex-col text-slate-800">\n        <h1 className="text-3xl text-center">My to dos</h1>\n        <NewTodo />\n        <ul className="px-6">\n          <TodoItem todos={todos} />\n        </ul>\n      </div>\n    </main>\n  );\n}\n')),(0,a.kt)("p",null,"That\u2019s all, you\u2019ve successfully created a Todo app with Next.js, Hanko, Prisma and Tailwind CSS!"))}m.isMDXComponent=!0},5438:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/cloud-organization-af07f2ecd00cbe79fa3eac231a0aad87.png"},113:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/dashboard-90540c81e64e399c17b6c5169f35d6c1.png"},9879:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/hanko-auth-2a5d3f6147456a0ceb3f7ec9dce7e82c.png"},636:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/hanko-profile-083a2b006d40d94bc546a39355a431f4.png"},6438:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/new-project-370f1ac1f0795227b16b925e65fa7491.png"}}]);